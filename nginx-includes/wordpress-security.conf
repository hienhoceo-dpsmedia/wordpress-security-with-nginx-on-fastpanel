# WordPress Security Configuration - High Priority Version
# File: /etc/nginx/fastpanel2-includes/wordpress-security.conf
# Uses exact match (=) and prefix match (^~) for highest priority

# ========== EXACT MATCH BLOCKS (HIGHEST PRIORITY) ==========
location = /xmlrpc.php { deny all; return 403; }
location = /wp-admin/install.php { deny all; return 403; }
location = /wp-content/debug.log { deny all; return 403; }
location = /readme.html { deny all; return 403; }
location = /license.txt { deny all; return 403; }
location = /wp-config.php { deny all; return 403; }
location = /wp-config-sample.php { deny all; return 403; }

# ========== PREFIX MATCH BLOCKS (HIGH PRIORITY) ==========
location ^~ /.git { deny all; return 403; }
location ^~ /.svn { deny all; return 403; }
location ^~ /.ht { deny all; return 403; }

# ========== REGEX BLOCKS (STILL HIGH PRIORITY FOR PHP) ==========
location ~* /wp-content/uploads/.*\.php$ { deny all; return 403; }
location ~* ^/wp-includes/.*\.php$ { deny all; return 403; }
location = /wp-includes/ms-files.php { }  # multisite exception
location ~* wp-config { deny all; return 403; }

# ========== BLOCK BACKUP & LOG FILES ==========
location ~* \.(bak|backup|old|orig|original|php~|php\.save|php\.bak|php#)$ { deny all; return 403; }
location ~* \.(log|sql|swp|swo)$ { deny all; return 403; }

# ========== BLOCK COMPRESSED ARCHIVES IN SENSITIVE DIRECTORIES ==========
location ~* ^/wp-content/(backups?|backupbuddy|updraft|ai1wm-backups|private|tmp|temp)/.*\.(zip|gz|tar|bz2|7z|rar)$ { deny all; return 403; }

# ========== BLOCK FILES IN PLUGINS & THEMES ==========
location ~* ^/wp-content/plugins/.+\.(txt|log|md)$ { deny all; return 403; }
location ~* ^/wp-content/themes/.+\.(txt|log|md)$  { deny all; return 403; }

# ========== ALLOW COMMON WELL-KNOWN PATHS ==========
location ^~ /.well-known/ { allow all; }

# ========== BLOCK HIDDEN FILES ==========
location ~* /\.user\.ini { deny all; return 403; }
location ~* /\. { deny all; return 403; }

# ========== BLOCK DANGEROUS SCRIPT TYPES ==========
location ~* \.(pl|cgi|py|sh|lua|asp|aspx|exe|dll)$ { deny all; return 403; }

# ========== BLOCK EXPLOIT FILES ==========
location ~* /(timthumb|thumb|thumbnail|phpinfo|webshell|shell|c99|r57|backdoor|evil|hack|mobiquo)\.php$ { deny all; return 403; }

# ========== BLOCK ATTACK PATTERNS ==========
set $wpsec_block_attack_patterns 0;
if ($args ~* '(?:eval\()') {
    set $wpsec_block_attack_patterns 1;
}
if ($args ~* '(?:base64_encode\s*\()') {
    set $wpsec_block_attack_patterns 1;
}
if ($args ~* '(?:GLOBALS|REQUEST)(?:=|\[|%)') {
    set $wpsec_block_attack_patterns 1;
}
if ($args ~* '(?:<|%3C).*script.*(?:>|%3E)') {
    set $wpsec_block_attack_patterns 1;
}
if ($args ~* '(?:%27|%22|\'|").*(?:drop|insert|md5|select|union)') {
    set $wpsec_block_attack_patterns 1;
}
if ($request_uri ~* '(?:boot\.ini|etc/passwd|self/environ)') {
    set $wpsec_block_attack_patterns 1;
}
if ($args ~* '127\.0\.0\.1') {
    set $wpsec_block_attack_patterns 1;
}
if ($args ~* '[a-z0-9]{2000,}') {
    set $wpsec_block_attack_patterns 1;
}
if ($args ~* '(?:javascript:|javascript%3a)') {
    set $wpsec_block_attack_patterns 1;
}
if ($wpsec_block_attack_patterns = 1) {
    return 403;
}

# ========== BLOCK FAKE GOOGLEBOTS ==========
set $wpsec_block_fake_googlebot 0;
if ($ua_is_googlebot = 1) {
    set $wpsec_block_fake_googlebot 1;
}
if ($is_verified_googlebot = 1) {
    set $wpsec_block_fake_googlebot 0;
}
if ($wpsec_block_fake_googlebot = 1) {
    return 403;
}
